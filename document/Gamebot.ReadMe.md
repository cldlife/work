# 谁是卧底机器人Read Me
-----------------------

用户玩'谁是卧底', '创建房间'后, 机器人自动加入房间,
陪用户玩'谁是卧底'的游戏.


## 机器人遵守的几条规则

1. 机器人在加入一个房间时, 房间处于 **已解散/游戏中/满足4人** 时**不加入**房间,
   这条规则**影响**其他的加入房间的规则, 优先级最高.

2. 用户在'创建房间'的 20s 后, 各有一个机器人加入房间.

3. 当 **机器人加入房间 / 房主踢人出房间 / 用户点击'开始游戏' / 用户点击'当前游戏状态'** 时,
   如果房间人数少于4人, 机器人会在10s后尝试加入房间.

4. 如果用户在'创建房间'后不开始游戏, 8s后机器人发条消息提醒.

5. 当房间'开始游戏'后, 机器人开始 **发言/投票**, 游戏中有一个特殊情况,
   当投票发生同票的时候, 会出现:

    - 发言规则: 一轮游戏中, 机器人的发言各不重复,
      机器人的发言由后台配置好.

    - 投票规则: 除非房间里只有1个机器人, 否则机器人不能投真实玩家

6. 在游戏结束后, 如果机器人输了, 就要接受惩罚, 10s后发送一条消息,
   消息内容由后台配置好, 如果有多个机器人输, 则随机挑选一位接受惩罚.

7. 当用户退出房间后, 机器人有以下行为:
    - 房间里面已经没有真实用户, 房间解散.
    - 房间里面还有真实用户, 房主转交给一位真实用户.

## 机器人实现思路

- 实现一个任务队列系统, 可以设定任务执行的时间. 通过这个任务队列系统
  就可以把机器人定时的自动行为转换成定时执行任务.

- 实现一个游戏配置管理后台, 可以人为的添加游戏卧底词/惩罚项等.
  机器人从数据库中随机的抽取相关的数据.

- 在'谁是卧底'游戏逻辑中添加机器人相关接口, 使机器人像一个普通玩家
  可以正常的进行游戏流程.

## 数据库设计

1. **任务队列数据库 dev_wanzhu_task**

    - task 表:

    |   列名         |   类型              |   简介   |
    |----------------|---------------------|----------|
    |      id        | int(10) unsigned    |  主键自增id |
    |     type       |  varchar(20)        |  任务类型:字符串表示, 不用来查询, 只在执行任务时用来区分任务类型  |
    |    run_time    |  int(10)            |  任务执行时间: unix时间戳表示 |
    |    workload    |  text               |  任务执行数据, 由于任务可以用于定时发送微信消息, 所以使用text类型 |
    |    status      |  tinyint(1)         |  任务状态: 0,未执行; 1,执行成功; 2,执行失败 |
    |  created_time  |  int(10) unsigned   |  任务创建时间 |
    |  updated_time  |  int(10) unsigned   |  任务更新时间 |

    主键: ` id `

    索引: `idx_st_runt (status, run_time)`


2. **游戏数据库 dev_wanzhu_game**

    - room_user 表:

    添加一栏`is_robot`, 表示该房间里玩家是机器人,

        ALTER TABLE room_user ADD is_robot TINYINT(1) NOT NULL DEFAULT '0' COMMENT '是否是机器人' AFTER uid;

    - game_setting 表:

    |   列名         |   类型              |   简介   |
    |----------------|---------------------|----------|
    |  id  |  int(10) unsigned  |  主键自增id  |
    |  rid  |  int(10) unsigned  |  对应的父记录id: 卧底词, 惩罚项目等  |
    |  type  |  tinyint(1)  |  游戏配置的类型: 1, 卧底词; 2, 惩罚项目; 0, 子记录  |
    |  content |  varchar(255)  |  游戏配置的内容, 卧底词时是json编码  |

    主键: ` id `

    索引: `idx_tp_rid (type, rid)`

    - pseudo_users 表:

    |   列名         |   类型              |   简介   |
    |----------------|---------------------|----------|
    |  uid  |  int(10) unsigned  |  机器人uid  |
    |  nickname  |  varchar(60) utf8mb4  |  机器人昵称  |
    |  is_using  |  tinyint(1)  |  机器人是否使用, 防止机器人同时进入多个房间  |
    |  avatar  |  varchar(255)  |  机器人使用的头像链接  |

    主键: ` uid `

    索引: `idx_using (is_using)`

## 运行方法

在终端里, 进入wanzhu项目根目录, 运行:

    $ ./shell/run.sh Gamebot

## TODO

  - 任务队列实现方式是通过轮询数据库来实现的, 在访问量大的时候必然会导致性能问题,
    如果任务队列系统的使用越来越频繁, 就需要重新设计实现了.
    一个可行的方案是引入`redis`替换数据库.

  - 由于开发时间的限制, 游戏配置的后台只实现了基本的功能, 可以对其中的一些部分进行
    改进, 添加几个功能, 方便运营同学操作.


